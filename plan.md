# 동적 폴더 기반 파일 목록 플러그인 구현 가이드

## 개요

이 문서는 현재 포커스된 문서가 속한 폴더의 파일들을 실시간으로 사이드바에 표시하는 Obsidian 플러그인을 만드는 방법을 설명합니다. 포커스가 다른 파일로 이동할 때마다 자동으로 해당 폴더의 파일 목록이 업데이트됩니다.

---

## AI에게 줄 프롬프트

Obsidian 플러그인을 만들고 싶어. 사이드바에 현재 활성화된 파일이 속한 폴더의 파일 목록을 표시하는 기능이야.

핵심 요구사항:
1. 사이드바에 커스텀 뷰 생성 (ItemView 상속)
2. 현재 활성화된 파일의 부모 폴더 경로 가져오기
3. 해당 폴더에 있는 모든 파일 목록 필터링
4. 파일 목록을 Obsidian 네이티브 스타일로 렌더링
5. file-open 이벤트를 감지하여 포커스가 바뀔 때마다 자동 업데이트
6. 현재 활성 파일은 is-active 클래스로 하이라이트 표시 (필수!)

동작 흐름:
- 사용자가 A 폴더의 file1.md를 열면 → A 폴더의 모든 파일 표시
- 사용자가 B 폴더의 file2.md로 이동하면 → B 폴더의 모든 파일로 변경
- 탭 전환, 파일 클릭 등 모든 파일 이동에 반응

필수 기능:
- 파일 클릭하면 해당 파일 열기
- 왼쪽 사이드바에 열기 명령어 (id: 'open-left')
- 오른쪽 사이드바에 열기 명령어 (id: 'open-right')
- 폴더명을 헤더로 표시하고 옆에 파일 개수 표시 (예: "Projects/Work (5개 파일)")
- 파일 목록은 가장 최근에 열린 파일이 제일 위에 오도록 정렬
  (최근 사용 순서 추적 필요 - 파일을 열 때마다 타임스탬프 기록)

전체 구현 코드를 보여줘.

---

## 동작 원리 상세 설명

### 1. 현재 활성 파일의 폴더 경로 파악

**핵심 개념:**
- Obsidian에서 `app.workspace.getActiveFile()`을 호출하면 현재 포커스된 파일 객체를 가져올 수 있습니다.
- 파일 객체에는 `path` 속성이 있는데, 이것은 전체 경로입니다 (예: `folder/subfolder/file.md`)
- 파일 객체의 `parent` 속성을 사용하면 부모 폴더 객체를 얻을 수 있습니다.
- 폴더 객체의 `path` 속성이 바로 폴더 경로입니다.

**작동 방식:**
1. 파일이 열릴 때마다 현재 활성 파일을 가져옴
2. 해당 파일의 부모 폴더를 찾음
3. 폴더가 없으면 (루트에 있으면) 루트 경로를 사용
4. 이 폴더 경로를 기준으로 파일 목록 필터링

**예시 시나리오:**
- `projects/work/report.md` 파일을 열면
- 부모 폴더는 `projects/work`
- `projects/work` 안의 모든 파일들을 찾아서 표시

---

### 2. 특정 폴더의 파일 목록 필터링

**핵심 개념:**
- `app.vault.getFiles()`를 호출하면 Vault의 모든 파일 배열을 가져옵니다.
- 각 파일의 `parent.path`를 현재 폴더 경로와 비교하여 필터링합니다.
- 서브폴더는 제외하고 정확히 같은 폴더에 있는 파일만 선택합니다.

**작동 방식:**
1. Vault의 모든 파일 가져오기
2. 각 파일을 순회하면서 부모 폴더 경로가 현재 폴더와 일치하는지 확인
3. 일치하는 파일만 배열로 모으기
4. 선택적으로 파일명 기준으로 정렬

**중요한 점:**
- `folder/subfolder/file.md`와 `folder/file.md`는 다른 폴더입니다.
- 정확히 같은 깊이의 폴더만 매칭되어야 합니다.
- 빈 폴더(파일이 없는 경우)도 처리할 수 있어야 합니다.

---

### 3. file-open 이벤트를 통한 실시간 업데이트

**핵심 개념:**
- Obsidian의 `app.workspace.on('file-open', callback)` 이벤트는 파일이 열릴 때마다 트리거됩니다.
- 이 이벤트는 탭 전환, 링크 클릭, 명령어를 통한 파일 열기 등 모든 경우에 발생합니다.
- 콜백 함수는 열린 파일 객체를 매개변수로 받습니다.

**작동 방식:**
1. 플러그인이 로드될 때 file-open 이벤트 리스너 등록
2. 파일이 열릴 때마다 콜백 함수 실행
3. 콜백 안에서:
   - 새로 열린 파일의 폴더 경로 파악
   - 해당 폴더의 파일 목록 다시 가져오기
   - 사이드바 뷰 리렌더링

**실시간 업데이트 시나리오:**
- 사용자가 파일 A를 클릭 → 이벤트 발생 → A의 폴더 파일 목록 표시
- 사용자가 탭을 전환하여 파일 B로 이동 → 이벤트 발생 → B의 폴더 파일 목록 표시
- 사용자가 검색으로 파일 C를 열기 → 이벤트 발생 → C의 폴더 파일 목록 표시

---

### 4. 뷰 리렌더링 최적화

**핵심 개념:**
- 파일이 열릴 때마다 전체 DOM을 재생성하면 성능 문제가 발생할 수 있습니다.
- 하지만 폴더가 바뀌는 경우에만 리렌더링하고, 같은 폴더 내에서 파일만 바뀌면 하이라이트만 업데이트할 수 있습니다.

**작동 방식:**
1. 이전 폴더 경로를 변수에 저장
2. file-open 이벤트가 발생하면 새 폴더 경로와 이전 경로 비교
3. 폴더가 바뀌었으면:
   - 전체 파일 목록 다시 가져오기
   - DOM 전체 재생성
4. 같은 폴더면:
   - 기존 DOM 유지
   - 하이라이트만 업데이트 (이전 활성 파일에서 is-active 제거, 새 파일에 추가)

**성능 이점:**
- 불필요한 DOM 조작 감소
- 부드러운 사용자 경험
- 같은 폴더 내 파일 이동 시 깜빡임 없음

---

### 5. 현재 폴더명 표시

**핵심 개념:**
- 사용자가 어느 폴더의 파일을 보고 있는지 명확히 알 수 있도록 폴더명을 헤더로 표시합니다.
- 폴더 깊이가 깊으면 전체 경로 또는 마지막 폴더명만 표시할 수 있습니다.

**작동 방식:**
1. 현재 폴더 경로에서 폴더명 추출
2. 뷰 상단에 헤더 요소 생성
3. 폴더명을 헤더에 표시
4. 선택적으로 전체 경로를 툴팁으로 제공

**사용자 경험:**
- "현재: Projects/Work" 같은 형태로 표시
- 루트 폴더에 있으면 "루트" 또는 "Vault 루트" 표시
- 폴더가 바뀔 때마다 헤더도 함께 업데이트

---

### 6. 엣지 케이스 처리

**고려해야 할 상황들:**

#### 6.1 파일이 없을 때
- 처음 플러그인을 열었는데 아무 파일도 열려있지 않은 경우
- 해결: "파일을 열어주세요" 같은 안내 메시지 표시
- 또는 전체 파일 목록 표시

#### 6.2 루트 폴더의 파일
- 폴더 구조 없이 Vault 최상위에 있는 파일들
- 해결: 부모 폴더가 null이면 루트로 간주하고 처리
- 루트의 모든 파일 표시

#### 6.3 빈 폴더
- 현재 파일만 있고 다른 파일이 없는 폴더
- 해결: "이 폴더의 유일한 파일입니다" 메시지 표시
- 또는 현재 파일만 목록에 표시

#### 6.4 파일 삭제/이동
- 목록에 표시된 파일이 삭제되거나 다른 폴더로 이동될 때
- 해결: `vault.on('delete')`, `vault.on('rename')` 이벤트도 감지
- 해당 이벤트 발생 시 목록 재계산

---

### 7. 필수 추가 기능

#### 7.1 활성 파일 하이라이트
**개념:**
- 현재 열려있는 파일을 목록에서 시각적으로 강조
- Obsidian 네이티브 스타일 사용

**동작:**
- 현재 활성 파일의 DOM 요소에 'is-active' 클래스 추가
- 파일이 바뀔 때마다 이전 파일에서 클래스 제거, 새 파일에 추가
- Obsidian의 기본 스타일이 자동으로 적용되어 배경색 변경

**구현 핵심:**
- `workspace.getActiveFile()`로 현재 파일 가져오기
- 파일 목록 렌더링 시 각 파일 경로와 현재 파일 경로 비교
- 일치하면 해당 DOM 요소에 `addClass('is-active')`

#### 7.2 왼쪽/오른쪽 사이드바 명령어
**개념:**
- 사용자가 원하는 위치에 뷰를 열 수 있도록 두 개의 명령어 제공
- Command Palette에서 검색하여 실행 가능

**동작:**
- "Open in Left Sidebar" 명령어: 왼쪽 사이드바에 뷰 생성
- "Open in Right Sidebar" 명령어: 오른쪽 사이드바에 뷰 생성
- 이미 열려있으면 해당 뷰로 포커스만 이동

**구현 핵심:**
- `addCommand()` 두 번 호출
- `workspace.getLeftLeaf(false)` vs `workspace.getRightLeaf(false)`
- `leaf.setViewState()`로 뷰 설정
- `workspace.revealLeaf()`로 사이드바 표시

#### 7.3 파일 개수 표시
**개념:**
- 현재 폴더에 총 몇 개의 파일이 있는지 헤더에 표시
- 사용자가 폴더의 규모를 한눈에 파악 가능

**동작:**
- 헤더에 "Projects/Work (5개 파일)" 형태로 표시
- 파일 목록이 업데이트될 때마다 개수도 함께 업데이트

**구현 핵심:**
- 필터링된 파일 배열의 `.length` 속성 사용
- 헤더 텍스트에 폴더명과 파일 개수 함께 표시

#### 7.4 최근 사용 순서 정렬
**개념:**
- 가장 최근에 열린 파일이 목록 맨 위에 표시
- 자주 사용하는 파일에 빠르게 접근 가능

**동작:**
- 파일을 열 때마다 해당 파일의 "마지막 열림 시간" 기록
- 목록 렌더링 시 이 시간 기준으로 내림차순 정렬
- 한 번도 열지 않은 파일은 파일명 순서로 뒤에 배치

**구현 핵심:**
- 플러그인 데이터에 `{ [filePath: string]: number }` 형태로 타임스탬프 저장
- file-open 이벤트에서 `Date.now()` 기록
- 정렬 시 `sort((a, b) => (timestamps[b.path] || 0) - (timestamps[a.path] || 0))`
- 플러그인 언로드 시 데이터 저장, 로드 시 복원

---

## 전체 동작 흐름 요약

```
1. 플러그인 로드
   ↓
2. 사이드바에 커스텀 뷰 등록
   ↓
3. file-open 이벤트 리스너 등록
   ↓
4. 사용자가 파일 A를 엶
   ↓
5. file-open 이벤트 트리거
   ↓
6. 파일 A의 부모 폴더 경로 파악 (예: "notes/daily")
   ↓
7. Vault의 모든 파일 중 부모가 "notes/daily"인 파일들 필터링
   ↓
8. 필터링된 파일 목록을 사이드바에 렌더링
   ↓
9. 파일 A에 is-active 클래스 추가 (하이라이트)
   ↓
10. 사용자가 파일 B로 이동 (다른 폴더)
   ↓
11. file-open 이벤트 다시 트리거
   ↓
12. 폴더 경로 비교 → 바뀜 감지
   ↓
13. 파일 B의 폴더 파일들로 목록 전체 갱신
   ↓
14. 파일 B에 하이라이트
   ↓
(계속 반복...)
```

---

## 핵심 포인트 정리

### 1. 폴더 경로 파악
- `activeFile.parent.path`로 현재 파일의 폴더 경로 가져오기
- 루트는 빈 문자열 또는 null

### 2. 파일 필터링
- `vault.getFiles().filter(file => file.parent.path === currentFolderPath)`
- 정확히 같은 폴더만 매칭

### 3. 실시간 업데이트
- `workspace.on('file-open', callback)`으로 파일 변경 감지
- 콜백 안에서 목록 갱신

### 4. 성능 최적화
- 이전 폴더 경로 저장하여 불필요한 리렌더링 방지
- 같은 폴더면 하이라이트만 변경

### 5. UI 구성
- 폴더명 헤더 + 파일 개수 (예: "Projects/Work (5개 파일)")
- Obsidian 네이티브 스타일 파일 목록
- 현재 파일 하이라이트 (is-active 클래스)
- 최근 사용 순서로 정렬된 파일 목록

### 6. 엣지 케이스
- 파일 없음, 루트 폴더, 빈 폴더, 파일 삭제/이동 처리

---

## AI에게 추가로 요청할 사항들

### 성능 최적화:
```
현재 코드를 최적화하고 싶어:
1. 폴더가 안 바뀌었으면 DOM 재생성 안 하고 하이라이트만 변경
2. 같은 폴더 내에서 파일 이동 시 깜빡임 없도록
3. 큰 폴더(파일 100개 이상)에서도 부드럽게 동작하게
```

### 엣지 케이스 처리:
```
다음 상황들을 처리해줘:
1. 파일이 없을 때 "파일을 열어주세요" 메시지 표시
2. 파일 삭제/이름 변경 이벤트 감지하여 목록 자동 업데이트
3. 루트 폴더의 파일들도 올바르게 처리
4. 빈 폴더일 때 적절한 메시지 표시
```

### 데이터 영속성:
```
최근 사용 순서 데이터를 영구 저장하고 싶어:
1. 플러그인 데이터로 타임스탬프 맵 저장
2. 플러그인 로드 시 이전 데이터 복원
3. 파일 삭제 시 해당 파일의 타임스탬프도 제거
```